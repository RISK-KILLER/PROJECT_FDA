# FDA RAG ì‹œìŠ¤í…œ í‰ê°€ ê°€ì´ë“œ

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
backend/evaluation/
â”œâ”€â”€ test_single.py          # ë‹¨ì¼ í…ŒìŠ¤íŠ¸ (ë””ë²„ê¹…ìš©)
â”œâ”€â”€ run_evaluation.py       # ì „ì²´ í‰ê°€ (ì„±ëŠ¥ ì¸¡ì •ìš©)
â”œâ”€â”€ evaluator.py            # í‰ê°€ ë¡œì§
â”œâ”€â”€ test_dataset.py         # í…ŒìŠ¤íŠ¸ ë°ì´í„°ì…‹
â””â”€â”€ results/                # í‰ê°€ ê²°ê³¼ ì €ì¥
    â””â”€â”€ baseline_20251024_*.json
```

---

## ğŸ¯ ë‘ ê°€ì§€ í‰ê°€ ë„êµ¬

### 1. `test_single.py` - ë¹ ë¥¸ ë””ë²„ê¹… ğŸ”§

**ëª©ì **: í•˜ë‚˜ì˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ìƒì„¸í•˜ê²Œ í™•ì¸

**ì–¸ì œ ì‚¬ìš©**:
- âœ… ì½”ë“œ ìˆ˜ì • í›„ ë¹ ë¥´ê²Œ í™•ì¸í•  ë•Œ
- âœ… íŠ¹ì • ì§ˆë¬¸ì˜ ë‹µë³€ì„ ìì„¸íˆ ë³¼ ë•Œ
- âœ… ê²€ìƒ‰ ë¬¸ì„œ ë‚´ìš©ì„ í™•ì¸í•  ë•Œ
- âœ… ë””ë²„ê¹…í•  ë•Œ

**ì‚¬ìš©ë²•**:
```bash
cd backend/evaluation

# ê¸°ë³¸ (definition_001)
python test_single.py

# íŠ¹ì • í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
python test_single.py --id authority_001

# ì‹¤ì œ ì±—ë´‡ ëª¨ë“œ (temperature=0.1)
python test_single.py --real-chatbot --id definition_001
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
================================================================================
[TEST] definition_001
================================================================================

[Q] ì§ˆë¬¸: What is a major food allergen?
[A] ì •ë‹µ: A major food allergen includes milk, eggs...
[K] í‚¤ì›Œë“œ: ['milk', 'eggs', 'fish', ...]

ğŸ¤– Agent ë‹µë³€ ìƒì„± ì¤‘...
ğŸ” ê²€ìƒ‰ëœ ë¬¸ì„œ ë‚´ìš© (ë””ë²„ê¹…)
============================================================
[ì¶œì²˜ 1] GUIDANCE (ì ìˆ˜: 0.710)
ì œëª©: Sec. 555.250  Major Food Allergen
ğŸ“ ì›ë³¸ í…ìŠ¤íŠ¸ ê¸¸ì´: 1998ì
ë‚´ìš© (ì²« 1000ì): ...

[Response] Agent ë‹µë³€:
--------------------------------------------------------------------------------
A major food allergen, as defined under FALCPA...
--------------------------------------------------------------------------------

[Generation] í‰ê°€:
  - Correctness:       1.000 / 1.0
  - Faithfulness:      1.000 / 1.0
  - Keyword Coverage:  80.0%
```

---

### 2. `run_evaluation.py` - ì „ì²´ í‰ê°€ ğŸ“Š

**ëª©ì **: ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê³  í†µê³„ ìƒì„±

**ì–¸ì œ ì‚¬ìš©**:
- âœ… ì‹œìŠ¤í…œ ì „ì²´ ì„±ëŠ¥ì„ ì¸¡ì •í•  ë•Œ
- âœ… ë²„ì „ ê°„ ì„±ëŠ¥ì„ ë¹„êµí•  ë•Œ
- âœ… ê°œì„  íš¨ê³¼ë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ í™•ì¸í•  ë•Œ
- âœ… ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•  ë•Œ

**ì‚¬ìš©ë²•**:
```bash
cd backend/evaluation

# ê¸°ë³¸ í‰ê°€
python run_evaluation.py

# ë²„ì „ëª… ì§€ì •
python run_evaluation.py --version v1.0_improved

# ì‹¤ì œ ì±—ë´‡ ëª¨ë“œ
python run_evaluation.py --real-chatbot --version production_test
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
================================================================================
ğŸ§ª FDA RAG ì‹œìŠ¤í…œ í‰ê°€ - baseline
================================================================================

ğŸ“ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤: 5ê°œ
ì¹´í…Œê³ ë¦¬: {'DEFINITION', 'PROCEDURE', 'AUTHORITY'}

================================================================================
[1/5] definition_001
================================================================================
â“ ì§ˆë¬¸: What is a major food allergen?
âœ… ì •ë‹µ: A major food allergen includes milk, eggs...
ğŸ”‘ í‚¤ì›Œë“œ: ['milk', 'eggs', 'fish', ...]

ğŸ¤– Agent ë‹µë³€ ìƒì„± ì¤‘...

ğŸ“ ë‹µë³€ (ì²« 200ì):
   A major food allergen, as defined under the Food Allergen Labeling...

ğŸ“š ê²€ìƒ‰ëœ ë¬¸ì„œ: 5ê°œ
   [1] guidance: Sec. 555.250  Major Food Allergen... (ì ìˆ˜: 0.710)
   [2] guidance: Guidance for Industry: Food Labeling Guide... (ì ìˆ˜: 0.706)
   ...

ğŸ“Š í‰ê°€ ì‹œì‘...

âœ… í‰ê°€ ì™„ë£Œ:
   - Correctness:  1.00
   - Faithfulness: 1.00
   - Keyword:      80%

================================================================================
[2/5] procedure_001
================================================================================
...

================================================================================
ğŸ¯ í‰ê°€ ì™„ë£Œ - ìµœì¢… ê²°ê³¼
================================================================================

ğŸ“Š ì „ì²´ í‰ê·  ì ìˆ˜:
  âœ… Correctness (ì •í™•ì„±):     0.950 / 1.0
  ğŸ“ Faithfulness (ì¶©ì‹¤ë„):    0.920 / 1.0
  ğŸ¯ Relevancy (ê´€ë ¨ì„±):       0.980 / 1.0
  ğŸ” Similarity (ìœ ì‚¬ë„):      0.650 / 1.0
  ğŸ”‘ Keyword Coverage (í‚¤ì›Œë“œ): 75.0%

ğŸ† ì¢…í•© í‰ê°€: A+ (ìš°ìˆ˜)

ğŸ“‚ ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸:

  ğŸ“Œ DEFINITION (2ê°œ í…ŒìŠ¤íŠ¸)
     - Correctness:  1.000
     - Faithfulness: 1.000

  ğŸ“Œ PROCEDURE (2ê°œ í…ŒìŠ¤íŠ¸)
     - Correctness:  0.900
     - Faithfulness: 0.850

ğŸ’¾ ìƒì„¸ ê²°ê³¼ ì €ì¥: evaluation/results/baseline_20251024_163245.json
ğŸ“ íŒŒì¼ ìœ„ì¹˜: backend/evaluation/results/
```

---

## ğŸ“Š í‰ê°€ ì§€í‘œ ì„¤ëª…

### 1. **Correctness (ì •í™•ì„±)** - ê°€ì¥ ì¤‘ìš”!
- **ì˜ë¯¸**: ì •ë‹µê³¼ ì–¼ë§ˆë‚˜ ì¼ì¹˜í•˜ëŠ”ê°€?
- **ë²”ìœ„**: 0.0 ~ 1.0 (1-5 ìŠ¤ì¼€ì¼ì„ ì •ê·œí™”)
- **ëª©í‘œ**: 0.8 ì´ìƒ
- **ì˜ˆì‹œ**:
  - 1.0: ì™„ë²½í•œ ë‹µë³€
  - 0.75: ëŒ€ë¶€ë¶„ ì •í™•, ì¼ë¶€ ëˆ„ë½
  - 0.5: ì ˆë°˜ë§Œ ì •í™•

### 2. **Faithfulness (ì¶©ì‹¤ë„)** - í™˜ê° ë°©ì§€!
- **ì˜ë¯¸**: ê²€ìƒ‰ëœ ë¬¸ì„œì— ì¶©ì‹¤í•œê°€? (í™˜ê° ì—†ìŒ)
- **ë²”ìœ„**: 0.0 ~ 1.0
- **ëª©í‘œ**: 0.9 ì´ìƒ
- **ì¤‘ìš”**: 0.0ì´ë©´ í™˜ê° ë°œìƒ (ëŒ€ì°¸ì‚¬!)
- **ì˜ˆì‹œ**:
  - 1.0: ëª¨ë“  ë‚´ìš©ì´ ë¬¸ì„œ ê¸°ë°˜
  - 0.5: ì ˆë°˜ì€ ì§€ì–´ë‚¸ ë‚´ìš©
  - 0.0: ê²€ìƒ‰ ë¬¸ì„œ ë‚´ìš© ì—†ìŒ (ì‹¬ê°)

### 3. **Relevancy (ê´€ë ¨ì„±)**
- **ì˜ë¯¸**: ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ ë‹µë³€ì¸ê°€?
- **ë²”ìœ„**: 0.0 ~ 1.0
- **ëª©í‘œ**: 0.9 ì´ìƒ

### 4. **Similarity (ìœ ì‚¬ë„)**
- **ì˜ë¯¸**: í‘œí˜„ì´ ì •ë‹µê³¼ ë¹„ìŠ·í•œê°€?
- **ë²”ìœ„**: 0.0 ~ 1.0
- **ì°¸ê³ **: ë‚®ì•„ë„ OK (ë‚´ìš©ì´ ì •í™•í•˜ë©´ ë¨)

### 5. **Keyword Coverage (í‚¤ì›Œë“œ ì»¤ë²„ë¦¬ì§€)**
- **ì˜ë¯¸**: ì¤‘ìš” í‚¤ì›Œë“œë¥¼ ì–¼ë§ˆë‚˜ í¬í•¨í•˜ëŠ”ê°€?
- **ë²”ìœ„**: 0% ~ 100%
- **ëª©í‘œ**: 70% ì´ìƒ

---

## ğŸ¯ í‰ê°€ ë“±ê¸‰ ê¸°ì¤€

### ì¢…í•© ì ìˆ˜ ê³„ì‚°
```python
í‰ê·  = (Correctness + Faithfulness + Relevancy) / 3
```

### ë“±ê¸‰í‘œ
| í‰ê·  ì ìˆ˜ | ë“±ê¸‰ | ì˜ë¯¸ |
|---------|------|------|
| 0.9+ | **A+ (ìš°ìˆ˜)** | í”„ë¡œë•ì…˜ ë°°í¬ ê°€ëŠ¥ âœ… |
| 0.8 - 0.9 | **A (ì–‘í˜¸)** | ê±°ì˜ ì™„ì„± ë‹¨ê³„ |
| 0.7 - 0.8 | **B+ (ë³´í†µ)** | ê°œì„  í•„ìš” |
| 0.7 ë¯¸ë§Œ | **B (ê°œì„  í•„ìš”)** | ì¶”ê°€ ì‘ì—… í•„ìš” |

---

## ğŸ”„ ê°œë°œ ì›Œí¬í”Œë¡œìš°

### 1. ê°œë°œ ì¤‘ (ë¹ ë¥¸ í™•ì¸)
```bash
# ì½”ë“œ ìˆ˜ì •
vim backend/utils/agent.py

# ë‹¨ì¼ í…ŒìŠ¤íŠ¸ë¡œ í™•ì¸
python evaluation/test_single.py --id definition_001

# ë¬¸ì œ ì—†ìœ¼ë©´ ë‹¤ìŒ í…ŒìŠ¤íŠ¸
python evaluation/test_single.py --id procedure_001
```

### 2. ë°°í¬ ì „ (ì „ì²´ í‰ê°€)
```bash
# ì „ì²´ í‰ê°€ ì‹¤í–‰
python evaluation/run_evaluation.py --version v1.2_final

# ê²°ê³¼ í™•ì¸
cat evaluation/results/v1.2_final_*.json

# ì´ì „ ë²„ì „ê³¼ ë¹„êµ
```

### 3. ë²„ì „ ë¹„êµ
```bash
# baseline í‰ê°€
python run_evaluation.py --version baseline

# ê°œì„  í›„ í‰ê°€
python run_evaluation.py --version improved

# ë‘ JSON íŒŒì¼ ë¹„êµ
```

---

## ğŸ“ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€ ë°©ë²•

### `test_dataset.py` ìˆ˜ì •

```python
def get_dataset():
    return [
        # ... ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ...
        
        # ìƒˆ í…ŒìŠ¤íŠ¸ ì¶”ê°€
        {
            "id": "new_test_001",
            "category": "COMPLIANCE",
            "difficulty": "hard",
            "question": "What are the HACCP requirements for seafood?",
            "ground_truth": "Seafood HACCP requires...",
            "expected_keywords": ["HACCP", "seafood", "critical control points", "monitoring"],
            "expected_collections": ["ecfr", "guidance"]
        }
    ]
```

---

## ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: Faithfulnessê°€ 0.0
```
ì›ì¸: citationsì— content í•„ë“œ ì—†ìŒ
í•´ê²°: agent.pyì—ì„œ content ì¶”ê°€ í™•ì¸
```

### ë¬¸ì œ 2: ë‹µë³€ì´ 2ê°œë§Œ ë‚˜ì—´
```
ì›ì¸: ê²€ìƒ‰ ë¬¸ì„œ ë¶€ì¡± (QUOTA_PER_COLLECTION=2)
í•´ê²°: orchestrator.pyì—ì„œ 5ë¡œ ì¦ê°€
```

### ë¬¸ì œ 3: ë§¤ë²ˆ ë‹¤ë¥¸ ê²°ê³¼
```
ì›ì¸: temperature=0.1
í•´ê²°: test_single.pyì—ì„œ temperature=0 ì‚¬ìš©
```

---

## ğŸ“Š ê²°ê³¼ íŒŒì¼ ë¶„ì„

### JSON êµ¬ì¡°
```json
{
  "summary": {
    "total_tests": 5,
    "timestamp": "2025-10-24T16:32:45"
  },
  "overall_metrics": {
    "correctness": 0.950,
    "faithfulness": 0.920,
    "relevancy": 0.980,
    "similarity": 0.650,
    "keyword_coverage": 0.750
  },
  "by_category": {
    "DEFINITION": {
      "count": 2,
      "correctness": 1.000,
      "faithfulness": 1.000
    }
  },
  "detailed_results": [
    {
      "test_id": "definition_001",
      "question": "What is a major food allergen?",
      "generation": {
        "correctness": 1.0,
        "faithfulness": 1.0,
        ...
      }
    }
  ]
}
```

---

## ğŸ’¡ ëª¨ë²” ì‚¬ë¡€

### DO âœ…
- ì½”ë“œ ìˆ˜ì • í›„ `test_single.py`ë¡œ ë¹ ë¥¸ í™•ì¸
- ë°°í¬ ì „ `run_evaluation.py`ë¡œ ì „ì²´ í‰ê°€
- ê²°ê³¼ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥í•˜ì—¬ ë²„ì „ ê´€ë¦¬
- ì •ê¸°ì ìœ¼ë¡œ í‰ê°€ ì‹¤í–‰ (ì£¼ 1íšŒ)

### DON'T âŒ
- ë‹¨ì¼ í…ŒìŠ¤íŠ¸ë§Œ ë³´ê³  ë°°í¬í•˜ê¸°
- Faithfulness 0.0ì„ ë¬´ì‹œí•˜ê¸°
- í‰ê°€ ì—†ì´ í”„ë¡¬í”„íŠ¸ ëŒ€í­ ìˆ˜ì •
- ì‹¤ì œ ì±—ë´‡ ëª¨ë“œë¡œ í‰ê°€í•˜ê¸° (ì¼ê´€ì„± ë–¨ì–´ì§)

---

## ğŸ¯ ëª©í‘œ ì„±ëŠ¥ (í”„ë¡œë•ì…˜)

| ì§€í‘œ | ëª©í‘œ | í˜„ì¬ (definition_001) |
|------|------|---------------------|
| Correctness | 0.9+ | âœ… 1.0 |
| Faithfulness | 0.9+ | âœ… 1.0 |
| Relevancy | 0.9+ | âœ… 1.0 |
| Similarity | 0.6+ | âœ… 0.66 |
| Keyword | 70%+ | âœ… 80% |

**í˜„ì¬ ìƒíƒœ**: í”„ë¡œë•ì…˜ ë°°í¬ ê°€ëŠ¥! ğŸš€

---

## ğŸ“š ì¶”ê°€ ìë£Œ

- `README_í‰ê°€ì°¨ì´ë¶„ì„.md` - í‰ê°€ì™€ ì‹¤ì œ ì±—ë´‡ ì°¨ì´ ì„¤ëª…
- `evaluator.py` - í‰ê°€ ë¡œì§ êµ¬í˜„
- `test_dataset.py` - í…ŒìŠ¤íŠ¸ ë°ì´í„°ì…‹

---

## â“ FAQ

**Q: test_single.pyì™€ run_evaluation.py ì¤‘ ë­˜ ì‚¬ìš©í•´ì•¼ í•˜ë‚˜ìš”?**
A: 
- ê°œë°œ ì¤‘: `test_single.py` (ë¹ ë¥¸ ë””ë²„ê¹…)
- ìµœì¢… í™•ì¸: `run_evaluation.py` (ì „ì²´ ì„±ëŠ¥)

**Q: ë‘˜ ë‹¤ í•„ìš”í•œê°€ìš”?**
A: ë„¤! ì—­í• ì´ ë‹¤ë¦…ë‹ˆë‹¤.
- `test_single.py`: ìƒì„¸í•œ ë””ë²„ê¹…
- `run_evaluation.py`: í†µê³„ì  ì„±ëŠ¥ ì¸¡ì •

**Q: ì‹¤ì œ ì±—ë´‡ ëª¨ë“œëŠ” ì–¸ì œ ì‚¬ìš©í•˜ë‚˜ìš”?**
A: ì‚¬ìš©ì ê²½í—˜ í…ŒìŠ¤íŠ¸ìš©ì…ë‹ˆë‹¤. í‰ê°€ì—ëŠ” ê¸°ë³¸ ëª¨ë“œ(deterministic)ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.

**Q: Faithfulnessê°€ ì™œ ì¤‘ìš”í•œê°€ìš”?**
A: í™˜ê°(hallucination)ì„ ë°©ì§€í•©ë‹ˆë‹¤. 0.0ì´ë©´ ê²€ìƒ‰ ë¬¸ì„œ ì—†ì´ ë‹µë³€í•œ ê²ƒì´ë¯€ë¡œ ì‹¬ê°í•œ ë¬¸ì œì…ë‹ˆë‹¤.

